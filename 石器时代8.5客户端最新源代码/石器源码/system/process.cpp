/************************/
/*	process.c			*/
/************************/
#include "../systeminc/version.h"
#include "../systeminc/system.h"
#include "../ohta/ohta.h"
//#include "../dwaf/dwafTestProc.h"
#include "../systeminc/map.h"
#include "../systeminc/ime_sa.h"
#include "../other/caryIme.h"
#include "../systeminc/menu.h"
#include "../systeminc/pc.h"
#include "../systeminc/character.h"
#include "../systeminc/login.h"
#include "../systeminc/netproc.h"
#include "../systeminc/savedata.h"
#include "../systeminc/testView.h"
#include "../systeminc/battleProc.h"
#include "../systeminc/produce.h"
#include "../systeminc/lssproto_cli.h"
#include "../systeminc/netmain.h"
#include "../systeminc/battleMenu.h"
#include "../systeminc/t_music.h"
#include "../systeminc/field.h"
#include "../systeminc/handletime.h"

#ifdef _NEW_MUISC_
BOOL ³õÊ¼±³¾°ÒôÀÖ=TRUE;
#endif
/* ???????? *******************************************************************/
extern void kakushi_command(void);
/* ????§k? */
UINT ProcNo;
/* ??????§k? */
UINT SubProcNo;
/* ????§k?(????????þú?¢v??) */
int ProcNo2;
int SubProcNo2;

int palNo;
int oldPalNo;
int palTime;

#ifdef _PET_TRACE_MOUSE
extern SCPlayPet PlayPet;
#endif

/* ?????? ********************************************************************/
void Process( void )
{
	if (ProcNo2 >= 0)
	{
		ProcNo = ProcNo2;
		ProcNo2 = -1;
		SubProcNo = SubProcNo2;
	}

	/* ????§Æ? */
	switch (ProcNo)
	{
		case PROC_OPENNING:
			break;
		case PROC_INIT: 	/* ??????? */
			InitProc();
			initMapEffect(TRUE);		// ???????????
			break;
		// ????????¦V???
		case PROC_ID_PASSWORD:
#ifdef _NEW_MUISC_
			if(³õÊ¼±³¾°ÒôÀÖ) {
				³õÊ¼±³¾°ÒôÀÖ=FALSE;
				play_bgm(27);
			}
#endif
			BackBufferDrawType = DRAW_BACK_NORMAL; 
			idPasswordProc();
#ifdef _PET_TRACE_MOUSE
			PlayPet.Proc();
#endif
			RunAction();			// ?????????
			StockTaskDispBuffer();	// ???¤úû¨????????????
			FlashKeyboardCursor();	// ?????????¤œþ˜??
			ImeProc();				// ???????
#ifdef _LOGINKICK			
			extern DWORD StartTime;
			StartTime = -1 ; 
#endif

			break;
		// ????¤úû¨?????¡k¢‘
		case PROC_TITLE_MENU:
			// ????????¤þ?©˜©œ¨Á?
			BackBufferDrawType = DRAW_BACK_NORMAL; 
			titleProc();
			TitleProduce();			// ?????üÒ
			RunAction();			// ?????????
			StockTaskDispBuffer();	// ???¤úû¨????????????

//cary 2002.1.4			kakushi_command();		// ????????
			break;
		// ???¡k¢‘?úð
		case PROC_CHAR_SELECT:		// ???¡k¢‘
			// ????????¤þ?©˜©œ¨Á?
			BackBufferDrawType = DRAW_BACK_NORMAL; 
			selectCharacterProc();
			break;
		// ????þÎ
		case PROC_CHAR_MAKE:
			// ????????¤þ?©˜©œ¨Á?
			BackBufferDrawType = DRAW_BACK_NORMAL; 
			makeCharacterProc();
			break;
		// ¡k¢‘??????????úð
		case PROC_CHAR_LOGIN_START:
			// ????????¤þ?©˜©œ¨Á?
			BackBufferDrawType = DRAW_BACK_NORMAL; 
			// charLoginStart();???????????????????
			// ?????????????
			initMap();		// ??????
			initPcAll();	// PCýÑ©?????????
			initCharObj();	// ????????????
			initOpenServerWindow();	// ????úùû¨?¤úû¨???????????
			initFieldProc();		// ??????¤úû¨§Ä????
			initMapEffect(FALSE);		// ???????????
			EncountFlag = FALSE;
			logOutFlag = FALSE;
			InitOhtaParam();	// ??????????¢^¤ ¡M??
#ifdef __SKYISLAND
			extern void SkyIslandInit();
			SkyIslandInit();
#endif
			ChangeProc( PROC_CHAR_LOGIN );
			// ???????????úð
			fade_out_bgm();
			break;
		case PROC_CHAR_LOGIN:
			// ????????¤þ?©˜©œ¨Á?
			BackBufferDrawType = DRAW_BACK_NORMAL; 
			characterLoginProc();
			break;
		// ?????
		case PROC_CHAR_LOGOUT:
			// ????????¤þ?©˜©œ¨Á?
//			BackBufferDrawType = DRAW_BACK_NORMAL; 
			characterLogoutProc();
			break;
		case PROC_GAME:     /* ??????? */
			GameProc();
			break;
		case PROC_DISCONNECT_SERVER:
			switch (SubProcNo)
			{
			case 0:
				// ???
				// PC????
				resetPc();
				// ?????????????
				initCharObj();
				// ??????úÇ
				DeathAllAction();
				// ?üÒ????
				ProduceInitFlag = TRUE;
				// ????????????þÎ 
				CopyBackBuffer();
				// ????????¤þ?©˜©œ¨Á?
				BackBufferDrawType = DRAW_BACK_PRODUCE; 
				// ???????????úð
				fade_out_bgm();
				// ????????
				NowTime = TimeGetTime();
				SubProcNo++;
				break;
			case 1:
				// ?üÒ?
				if (DrawProduce(PRODUCE_DOWN_ACCELE) == TRUE)
				{
					BackBufferDrawType = DRAW_BACK_NORMAL; 
					SubProcNo++;
				}
				break;
			case 2:
				// ?üÒ?ü¬??
				break;
			}
			// þú£e?????????
			if (disconnectServer())
			{
				// ?????????
				cleanupNetwork();
				// ????????????
				PaletteChange(DEF_PAL, 0);
				// ?????þ?
				//cary
				ChangeProc( PROC_ID_PASSWORD );
				SubProcNo = 0;
				// ??????úÇ
				DeathAllAction();
				disconnectServerFlag = FALSE;
				oldDisconnectServerFlag = FALSE;
				break;
			}
			RunAction();			// ?????????
			StockTaskDispBuffer();	// ???¤úû¨????????????
			break;
		case PROC_BATTLE:     /* ??????? */
			BattleProc();
			break;
#ifdef _STONDEBUG_		
		//case PROC_OHTA_TEST:     /* ¢^¤ ??????? */
		//	OhtaTestProc();
		//	break;
		//case PROC_TAKE_TEST:     /* £{¥›????????? */
		//	TakeTestProc();
		//	break;
		//case PROC_DWAF_TEST:	// DWAF???
		//	dwafTestProc();
		//	break;
		case PROC_SPR_VIEW:		// ??????¦_????
			SprViewProc();
			break;
		case PROC_ANIM_VIEW:	// ????????¦_????
			AnimViewProc();
			break;
		case PROC_SE_TEST:	// ???¦_????
			SeTestProc();
			break;
#endif
#ifdef _80_LOGIN_PLAY
		case PROC_80_LOGIN:
			BackBufferDrawType = DRAW_BACK_NORMAL; 
			_80LoginProc();
			RunAction();
			StockTaskDispBuffer();
			break;
#endif
#ifdef _PK2007
		case PROC_PKSERVER_SELECT:
			BackBufferDrawType = DRAW_BACK_NORMAL; 
			selectpkProc();
			break;
#endif
		case PROC_ENDING:
			break;
	}
}

/* ????¨Á??? ***********************************************************/
void ChangeProc( int procNo )
{
#ifdef _NEW_MUISC_
	if(PROC_ID_PASSWORD==procNo){
		³õÊ¼±³¾°ÒôÀÖ=TRUE;
		//t_music_se_volume = t_music_bgm_volume = 15;
	}
#endif
	ProcNo = procNo;
	// ??????§k?????
	SubProcNo = 0;


}
/* ????¨Á??? ***********************************************************/
void ChangeProc( int procNo, int subProcNo )
{
	// ????§k????
	ProcNo = procNo;
	// ??????§k?????
	SubProcNo = subProcNo;
}
/* ????¨Á??????????????þú?¢v???**************************/
void ChangeProc2( int procNo )
{
	// ????§k????
	ProcNo2 = procNo;
	SubProcNo2 = 0;
}
/* ????¨Á??? ***********************************************************/
void ChangeProc2( int procNo, int subProcNo )
{
	// ????§k????
	ProcNo2 = procNo;
	// ??????§k?????
	SubProcNo2 = subProcNo;
}

void GameProc( void )
{
	static int now_bgm;
	static BOOL produceFlag;
	switch( SubProcNo ){
		case 0:
			//cary ·ÀÖ¹ÔÙ´ÎµÇÈëÊ±µÄÊÓ´°²ÐÁô
			extern short helpBtn, actBtn;
			helpBtn = 0;
			actBtn = 0;
			//end cary
#ifdef _DEBUG__
			if( offlineFlag ){
				initMap();
			}
#endif
			//InitIme();
			ClearIme();
			InitChat();
			produceFlag = FALSE;
			EncountFlag = FALSE;
			LoadAlbum();
			extern void AI_Init();
			AI_Init();
			nameOverTheHeadFlag = 0;
			SubProcNo++;
		case 150:
			SubProcNo = 100;

		case 100:
			initPc();
			resetFieldProc();
			restorePtActCharObjAll();
			initOpenServerWindow();
			InitMenu();
//			BattleStatusBak[ 0 ] = NULL;// ???ýÖ¢t???
//			BattleStatusReadPointer = BattleStatusWritePointer =0;
			GetKeyInputFocus( &MyChatBuffer );
			SubProcNo++;
		case 101:
			if( loginFlag ){
				BackBufferDrawType = DRAW_BACK_NORMAL; 
				break;
			}
			SubProcNo++;
		case 102:
			paletteProc();

			DispBuffer.DispCnt = 0;
			FontCnt = 0;
			initCharPartsPrio();	// ?????????¡I???¤e??????
			RunAction();			// ?????????
			StockTaskDispBuffer();	// ???¤úû¨????????????
			stop_bgm();				//???¤_û¢
			drawMap();				//	???¤úû¨
			MenuProc();				// ??????
			ChatProc();				// ??????
			ChatBufferToFontBuffer(); // ??????????????????????
			ImeProc();				// ???????
			SortDispBuffer(); 	// ¤úû¨???????
			// ???????????????
			ClearBackSurface();	
			// ????????????????
			PutBmp();	
			// ??????????????????????
			lpBattleSurface->BltFast( 0, 0, lpDraw->lpBACKBUFFER, NULL, DDBLTFAST_WAIT );
			// ???????
			DispBuffer.DispCnt = 0;
			FontCnt = 0;

			play_bgm( map_bgm_no );

			// ????????
			NowTime = TimeGetTime();
			// ????????¤þ?©˜©œ¨Á?
//			BackBufferDrawType = DRAW_BACK_NORMAL; 
			BackBufferDrawType = DRAW_BACK_PRODUCE; 
			// ?üÒ?
			ProduceInitFlag = TRUE;
			DrawProduce( PRODUCE_BRAN_BIG );
/*#ifdef __SKYISLAND
			ClearBackSurface();
#endif*/
			SubProcNo++;
			break;

		case 103:
			// ?üÒ?
			BackBufferDrawType = DRAW_BACK_PRODUCE; 
			if( DrawProduce( PRODUCE_BRAN_BIG ) == TRUE )
			{
				produceFlag = TRUE;
				fieldInfoTime = TimeGetTime();
				if( fastDrawTile )
				{
					SubProcNo = 20;
				}
				else
				{
					SubProcNo = 3;
				}
			}
			break;

		// ????üÒ
		case 200:
			ProduceInitFlag = TRUE;

			// ???????
			DispBuffer.DispCnt = 0;
			FontCnt = 0;

			// ????????
			NowTime = TimeGetTime();

			// S??????C? warpEffectProc();?????
			// ?þ???????????????
			SubProcNo++;

		case 201:
			// ?üÒ?
			BackBufferDrawType = DRAW_BACK_PRODUCE; 
			if( DrawProduce( PRODUCE_CENTER_PRESSIN ) == TRUE )
			{
				SubProcNo++;
			}
			drawField();	// ??????þ?????¤úû¨
			MenuProc();	// ??????
			ImeProc();	// ???????
			break;

		case 202:
			if( !warpEffectStart || !warpEffectOk )
			{
				BackBufferDrawType = DRAW_BACK_NORMAL; 
				drawField();	// ??????þ?????¤úû¨
				MenuProc();	// ??????
				ImeProc();	// ???????
				break;
			}
			warpEffectStart = FALSE;
			warpEffectOk = FALSE;
			SubProcNo++;
		case 203:
			// ?üÒ????þÎ
			// ???????
			paletteProc();

			DispBuffer.DispCnt = 0;
			FontCnt = 0;
			initCharPartsPrio();	// ?????????¡I???¤e??????
			RunAction();			// ?????????
			StockTaskDispBuffer();	// ???¤úû¨????????????
			redrawMap();
			drawMap();				//	???¤úû¨

			// ?????????
			if( (mapEffectRainLevel == 0 && oldMapEffectRainLevel != 0 ) 
				|| (mapEffectSnowLevel == 0 && oldMapEffectSnowLevel != 0 )
				)
				initMapEffect(FALSE);
			ChatProc();				// ??????
			ChatBufferToFontBuffer(); // ??????????????????????
			SortDispBuffer(); 	// ¤úû¨???????
			// ???????????????
			ClearBackSurface();	
			if( (mapEffectRainLevel != 0 && oldMapEffectRainLevel == 0 )
			 || (mapEffectSnowLevel != 0 && oldMapEffectSnowLevel == 0 ) )
				mapEffectProc2( 80 );		// ???????????¡D??
			// ????????????????
			PutBmp();	
			// ??????????????????????
			lpBattleSurface->BltFast( 0, 0, lpDraw->lpBACKBUFFER, NULL, DDBLTFAST_WAIT );
			// ???????
			DispBuffer.DispCnt = 0;
			FontCnt = 0;

//			if( map_bgm_no != now_bgm )
//			{
//				stop_bgm();				//???¤_û¢
//				play_bgm( map_bgm_no );
//			}

			// ????????
			NowTime = TimeGetTime();

			ProduceInitFlag = TRUE;

			SubProcNo++;

		case 204:
			// ?üÒ?
			BackBufferDrawType = DRAW_BACK_PRODUCE; 
			if( DrawProduce( PRODUCE_CENTER_PRESSOUT ) == TRUE )
			{
				fieldInfoTime = TimeGetTime();
				if( fastDrawTile )
				{
					SubProcNo = 20;
				}
				else
				{
					SubProcNo = 3;
				}
		#ifdef _NPC_DANCE
				if( nowFloor == 7027 )
					play_bgm ( 24 ) ;
		#endif
			}
			drawField();	// ??????þ?????¤úû¨
			MenuProc();	// ??????
			ImeProc();	// ???????
			break;


		case 1:
			initPc();				// ?????????þÎ
			resetFieldProc();		// ????????????
			restorePtActCharObjAll();	// ?????????????????
			initOpenServerWindow();	// ????úùû¨?¤úû¨???????????
			InitMenu();		// ??????????
//			BattleStatusBak[ 0 ] = NULL;// ???ýÖ¢t???
//			BattleStatusReadPointer = BattleStatusWritePointer =0;
			// ¦V??????ûè¥x
			GetKeyInputFocus( &MyChatBuffer );

			// ?üÒ???
			if( produceFlag == TRUE ){
			// ¡P¥f????????????
			//if( BattleResultWndFlag == TRUE ){

				// ?üÒ????þÎ
				// ???????
				DispBuffer.DispCnt = 0;
				FontCnt = 0;
				initCharPartsPrio();	// ?????????¡I???¤e??????
				RunAction();			// ?????????
				StockTaskDispBuffer();	// ???¤úû¨????????????
				stop_bgm();				//???¤_û¢
				updateMapArea();
				redrawMap();
				drawMap();				//	???¤úû¨
				//????????
				if(!draw_map_bgm_flg){
					//????????þØ
					play_bgm(map_bgm_no = now_bgm);
					draw_map_bgm_flg = 1;
				}
				MenuProc();				// ??????
				// ???????¥D??????ýè?
				//StockBoxDispBuffer( 0, 456, lpDraw->xSize, lpDraw->ySize, DISP_PRIO_MENU, 0, 1 );
				ChatProc();				// ??????
				ChatBufferToFontBuffer(); // ??????????????????????
				ImeProc();				// ???????
				SortDispBuffer(); 	// ¤úû¨???????
				// ???????????????
				ClearBackSurface();	
				// ????????????????
				PutBmp();	
				// ??????????????????????
				lpBattleSurface->BltFast( 0, 0, lpDraw->lpBACKBUFFER, NULL, DDBLTFAST_WAIT );
				// ???????
				DispBuffer.DispCnt = 0;
				FontCnt = 0;
				// ????????
				NowTime = TimeGetTime();
				// ????????¤þ?©˜©œ¨Á?
				BackBufferDrawType = DRAW_BACK_PRODUCE; 
				// ?üÒ?
				DrawProduce( PRODUCE_4WAY_IN );
			}else{
				// ?üÒ?????
				produceFlag = TRUE;
				SubProcNo++;
			}
			SubProcNo++;
			
			break;
		
		case 2:	// ????????üÒ
			// ?üÒ?
			if( DrawProduce( PRODUCE_4WAY_IN ) == TRUE ){
				warpEffectStart = FALSE;
				warpEffectOk = FALSE;
				if( fastDrawTile )
				{
					SubProcNo = 20;
				}
				else
				{
					SubProcNo = 3;
				}
			}
			break;


		case 20:
			BackBufferDrawType = DRAW_BACK_NORMAL; 
			repairMap();
			SubProcNo = 3;

		case 3:
			// ????????¤þ?©˜©œ¨Á?
			
			BackBufferDrawType = DRAW_BACK_NORMAL; 
			paletteProc();

			initItemOverlapCheck();	// ????üÇ????????????

			if( !transmigrationEffectFlag ){
				drawGrid();				// ????????¤úû¨
				fieldProc();			// ?????????
				// Nuke 0407
				if( bNewServer){
					moveProc();				// ?¥h??
				}else
					moveProc();				// ?¥h??
			}

			initCharPartsPrio();	// ?????????¡I???¤e??????
			//addressBookProc();		// ?????????
			openServerWindowProc();	// ????þÉ?????
			drawFieldInfoWin();		// ?????ýÍ?ýÑ©
			
			/* ????????? */
			RunAction();
			// ???¤úû¨????????????
			// úù¤e§d?????????
			StockTaskDispBuffer();

			mapEffectProc();		// ???????????¡D??

			drawMap2();		// ???¤úû¨

            if( !transmigrationEffectFlag ){
			    drawField();	// ??????þ?????¤úû¨

			/* ?????? */
			    ChatProc();
			// ??????????????????????
			    ChatBufferToFontBuffer(); 
			// ?????????¤œþ˜??
			    FlashKeyboardCursor();
			// ??????
 			    MenuProc();
			// ???????
			    ImeProc();		
			}
			// ??¢q?????????????
			TimeZoneProc();
			
/*cary
#ifdef _STONDEBUG_
			// ?????????
			if( joy_trg[ 0 ] & JOY_P_DOWN ){
				if( pc.ptAct != NULL ){
					resetMap();					// ?????????
					// ???????ýï
					if( bNewServer)
						lssproto_EN_send( sockfd, pc.ptAct->gx, pc.ptAct->gy );
					else
						old_lssproto_EN_send( sockfd, pc.ptAct->gx, pc.ptAct->gy );
					eventEnemyFlag = 0;
				}
			}
#endif
*/
			// ?????????
			if( EncountFlag == TRUE ){
				resetPc();				// PC????
				resetCharObj();			// ?????????????
				resetMap();				// ?????????
				clearPtActPartyParam();	// ??ýÑ©?????????????NULL???
				fieldInfoTime = 0;		// ýÍ?ýÑ©?üÒ???ý¤?
				drawFieldInfoWin();		// ?????ýÍ?ýÑ©
				resetFieldProc();		// ????????????
				nowEncountPercentage = minEncountPercentage;// ?????????üí???
				sendEnFlag = 0;
				encountNowFlag = 1;
				eventEnemySendFlag = 0;
				duelSendFlag = 0;
				jbSendFlag = 0;
				// ?????????????????
				if( MenuToggleFlag & JOY_CTRL_M ) MapWmdFlagBak = TRUE;
				// ý¤???????????
				ResultWndTimer = RESULT_WND_CLOSE_TIME;
				InitMenu();			// ??????????
				BattleCmd[ 0 ] = NULL;		// ??????????
//				BattleCmdBak[ 0 ] = NULL;	// ??????????
//				BattleCmdReadPointer = BattleCmdWritePointer =0;
				BattleStatus[ 0 ] = NULL;	// ???ýÖ¢t???
				//BattleStatusBak[ 0 ] = NULL;// ???ýÖ¢t???
//				BattleStatusReadPointer = BattleStatusWritePointer =0;
				BattleTurnReceiveFlag = TRUE;	// ???ûõýï?????
				// ???????
				play_se( 215, 320, 240 );
				// ??????¨ò¢V
				now_bgm = t_music_bgm_no;
				// ???¤_û¢
				stop_bgm();
				//SubProcNo++;
				ChangeProc2( PROC_GAME, SubProcNo+1 );
			//	printf("\nÕ½¶·Ô¤´¦ÀíÖ´ÐÐÍê±Ï SubProcNo=%d",SubProcNo+1);
			}
			break;
			
		case 4:	// ??????????üÒ??????????
			// ????????????þÎ 
			CopyBackBuffer();
			// ????????¤þ?©˜©œ¨Á?
			BackBufferDrawType = DRAW_BACK_PRODUCE; 
			SubProcNo++;
		//	printf("\nDRAW_BACK_PRODUCEÖ´ÐÐÍê±Ï SubProcNo=%d",SubProcNo);
			break;
			
		case 5:	// ???????üÒ
		
			// ?üÒ?
			if( DrawProduce( PRODUCE_HAGARE_OCHI_OUT ) == TRUE ){
			//if( DrawProduce( PRODUCE_RIGHT_ACCELE ) == TRUE ){
			//if( DrawProduce( PRODUCE_LEFT_RIGHT_ACCELE ) == TRUE ){
			//if( GameState == GAME_ENCOUNT_TO_BATTLE ){ 
				// ????????
#ifdef _HALLOWEEN_EFFECT
				initMapEffect(FALSE);	
#endif
				ChangeProc( PROC_BATTLE );
		//		printf("\nPROC_BATTLE¸ü»»Íê±Ï SubProcNo=%d",SubProcNo);
			}
			
			MenuProc();	// ??????
		//	printf("\nMenuProcÖ´ÐÐÍê±Ï");
			ImeProc();	// ???????
		//	printf("\nImeProcÖ´ÐÐÍê±Ï");
			break;
	}
}


// ????üÒ?
void warpEffectProc( void )
{
	oldMapEffectRainLevel = mapEffectRainLevel;
	oldMapEffectSnowLevel = mapEffectSnowLevel;

	DispBuffer.DispCnt = 0;
	FontCnt = 0;

	// ?????????????????
	if( MenuToggleFlag & JOY_CTRL_M ) MapWmdFlagBak = TRUE;
	InitMenu2();

	fieldProc();			// ?????????
	initCharPartsPrio();	// ?????????¡I???¤e??????
	openServerWindowProc();	// ????þÉ?????

	fieldInfoTime = 0;		// ýÍ?ýÑ©?üÒ???ý¤?
	drawFieldInfoWin();		// ?????ýÍ?ýÑ©


	/* ????????? */
	RunAction();
	// ???¤úû¨????????????
	StockTaskDispBuffer();

	mapEffectProc();		// ???????????¡D??

	redrawMap();
	drawMap();		// ???¤úû¨
	/* ?????? */
	ChatProc();
	// ??????????????????????
	ChatBufferToFontBuffer(); 
	// ??¢q?????????????
//	TimeZoneProc();
	SortDispBuffer(); 	// ¤úû¨???????
	// ???????????????
	ClearBackSurface();	
	// ????????????????
	PutBmp();	

#ifndef __SKYISLAND
	// ??????????????????????
	lpBattleSurface->BltFast( 0, 0, lpDraw->lpBACKBUFFER, NULL, DDBLTFAST_WAIT );
#endif
}


void repairMap( void )
{
	float dx, dy;
#ifdef _MOVE_SCREEN
	if (pc.bMoveScreenMode)
	{
		dx = (float)(+ (-nowGx) * (SURFACE_WIDTH >> 1) + -nowGy * (SURFACE_WIDTH >> 1) + viewOffsetX);
		dy = (float)(- (-nowGx) * (SURFACE_HEIGHT >> 1) + -nowGy * (SURFACE_HEIGHT >> 1) + viewOffsetY);
	}
	else
#endif
	//
		camMapToGamen( 0.0, 0.0, &dx, &dy );

	nowXFastDraw = (int)(dx+.5);
	nowYFastDraw = (int)(dy+.5);

	nowXFastDraw2 = nowXFastDraw;
	nowYFastDraw2 = nowYFastDraw;

	//???????????????
	if( ResoMode == 1 ){
		nowXFastDraw = (int)(dx/2+.5);
		nowYFastDraw = (int)(dy/2+.5);
	}

	baseXFastDraw = nowXFastDraw;
	baseYFastDraw = nowYFastDraw;
	amountXFastDraw = nowXFastDraw - baseXFastDraw;
	amountYFastDraw = nowYFastDraw - baseYFastDraw;

	DispBuffer.DispCnt = 0;
	FontCnt = 0;
	drawTile();		// ???¤úû¨
	SortDispBuffer(); 	// ¤úû¨???????
	// ???????????????
	//cary 2001 11 8
	ClearBackSurface();	

	// ????????????????
	fastDrawTileFlag = 0;
	PutBmp();	
	fastDrawTileFlag = 1;
#ifndef __SKYISLAND
	// ??????????????????????
	lpBattleSurface->BltFast( 0, 0, lpDraw->lpBACKBUFFER, NULL, DDBLTFAST_WAIT );
#endif
	DispBuffer.DispCnt = 0;
	FontCnt = 0;
	// ????????
	NowTime = TimeGetTime();
}


void paletteProc( void )
{
	if( palNo == -1 )
	{
		// ????????
		// the second PaletteChange( SaTimeZoneNo, 0 );
		PaletteChange( SaTimeZoneNo, palTime );
		// ??¢q????????????
		TimeZonePalChangeFlag = TRUE;
		palNo = -2;
	}
	else
	if( palNo >= 0 )
	{
		// ?¤e????¡@¤e
		// the second PaletteChange( palNo, 0 );// ????????
		PaletteChange( palNo, palTime );// ????????
		// ??¢q?????????????
		TimeZonePalChangeFlag = FALSE;
		palNo = -2;
	}
}

#ifdef _SURFACE_ANIM
extern ACTION *SPACT[MAX_ANIM];
void AniProc()
{
	float mx,my;

	for (int i = 0; i < MAX_ANIM; i++)
	{
		if(SPACT[i] != NULL)
		{
			camMapToGamen(SPACT[i]->mx, SPACT[i]->my, &mx, &my);
			if(SPACT[i]->anim_chr_no > 102002){
				SPACT[i]->x = (int)(mx - 5);
				SPACT[i]->y = (int)(my + 8);
			}else{
				SPACT[i]->x = (int)(mx +.5);
				SPACT[i]->y = (int)(my +.5);
			}
			pattern(SPACT[i], ANM_NOMAL_SPD, ANM_LOOP);
		}
	}
}
#endif